# FHIR4Java Server Configuration
server:
  port: 8080
  servlet:
    context-path: /

spring:
  application:
    name: fhir4java-server

  # JPA / Hibernate Configuration
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    open-in-view: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        jdbc:
          batch_size: 50
        order_inserts: true
        order_updates: true
        default_schema: fhir

  # DataSource Configuration
  datasource:
    url: jdbc:postgresql://localhost:5432/fhir4java
    username: fhir4java
    password: fhir4java
    driver-class-name: org.postgresql.Driver
    hikari:
      pool-name: fhir4java-pool
      minimum-idle: 5
      maximum-pool-size: 20
      idle-timeout: 30000
      max-lifetime: 1800000
      connection-timeout: 30000

  # Flyway Migration
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
    validate-on-migrate: true
    schemas: fhir

  # Redis Cache Configuration
  data:
    redis:
      host: localhost
      port: 6379
      timeout: 2000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 2

  # Cache Configuration
  cache:
    type: redis
    redis:
      time-to-live: 3600000
      cache-null-values: false

  # Jackson JSON Configuration
  jackson:
    serialization:
      write-dates-as-timestamps: false
    deserialization:
      fail-on-unknown-properties: false
    default-property-inclusion: non_null

# FHIR4Java Server Configuration
fhir4java:
  server:
    # Global default FHIR version (used when resource doesn't specify or URL is unversioned)
    default-version: R5
    # Base URL for the FHIR server (without version suffix)
    base-url: http://localhost:8080/fhir
    # Default page size for search results
    default-page-size: 20
    # Maximum page size allowed
    max-page-size: 1000
    # Enable validation on create/update
    validation-enabled: true

  # Supported FHIR versions
  versions:
    enabled:
      - R5
      # - R4B  # Uncomment to enable R4B support

  # Configuration paths
  config:
    # Base path for all FHIR configuration files
    base-path: classpath:fhir-config/
    # Resource YAML configurations (version-agnostic)
    resources-path: ${fhir4java.config.base-path}resources/
    # Version-specific paths are derived automatically:
    #   ${fhir4java.config.base-path}r5/searchparameters/
    #   ${fhir4java.config.base-path}r5/operations/
    #   ${fhir4java.config.base-path}r5/profiles/
    #   ${fhir4java.config.base-path}r4b/searchparameters/
    #   etc.

  # Validation settings
  validation:
    enabled: true

    # Enable/disable ProfileValidator initialization
    # Set to false for faster startup in dev/test environments where profile validation is not needed
    profile-validator-enabled: true

    # Profile validation strictness mode (controls how validation results are handled)
    # - strict: Full validation, errors cause rejection
    # - lenient: Validation is performed but warnings don't cause rejection
    # - off: No profile validation is performed
    profile-validation: off

    # Parser error handler mode (controls how unknown/invalid elements are handled during parsing)
    # - strict: Throws exceptions for unknown elements (recommended for production)
    # - lenient: Logs warnings for unknown elements but allows parsing to continue
    parser-error-handler: strict

    # Enable detailed logging of validation operations
    # Set to true for debugging validation issues (logs each validation attempt and result)
    log-validation-operations: false

    # Enable lazy per-version initialization (experimental feature)
    # When true, validators initialize on first use per FHIR version
    # This reduces startup time to near-zero while maintaining functionality for actively used versions
    lazy-initialization: false

    # Health check sensitivity mode
    # - strict: Report DOWN if no validators initialized successfully (default, ensures operators know when validation is broken)
    # - warn: Report UP with warning details if no validators initialized (allows graceful degradation)
    # - disabled: Always report UP regardless of validator status
    health-check-mode: strict

  # Plugin system settings
  plugins:
    enabled: true
    # Default plugin toggles
    authentication:
      enabled: false # Set true + provide custom AuthenticationPlugin for production
    authorization:
      enabled: false # Set true + provide custom AuthorizationPlugin for production
    audit:
      enabled: true # Logging-based audit by default
    telemetry:
      enabled: true # Logging-based telemetry by default
    performance:
      enabled: true # In-memory performance tracking by default
    cache:
      enabled: false # Enable when cache plugin is provided
    async-pool-size: 4 # Thread pool size for async plugins
    business-logic:
      fail-on-error: true # Fail the request if a business logic plugin errors
    # Sample Patient CREATE plugin settings
    patient-create:
      enabled: true
      require-family-name: true # Reject Patient without family name
      auto-generate-mrn: true # Auto-generate MRN identifier if missing
      mrn-system: 'urn:fhir4java:patient:mrn' # Identifier system URI for auto-generated MRN
      add-creation-timestamp: true # Add creation timestamp extension
      creation-timestamp-url: 'http://fhir4java.org/StructureDefinition/creation-timestamp' # Extension URL for creation timestamp
      duplicate-check-enabled: true # Check for duplicate identifiers before creating
      duplicate-check-systems: # Identifier systems to check for duplicates (empty = all)
        - 'urn:fhir4java:patient:mrn'
        - 'http://hl7.org/fhir/sid/us-ssn'

  # Multi-tenancy
  tenant:
    enabled: false
    default-tenant-id: default
    header-name: X-Tenant-ID

# Actuator Configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      show-components: always # Expose individual health indicators including profileValidator
  metrics:
    enable:
      all: true # Enable all metrics
    tags:
      application: fhir4java-server
      environment: ${spring.profiles.active:default}
  health:
    db:
      enabled: true
    redis:
      enabled: true
    # Profile validator health indicator automatically enabled
    # Reports initialization status of FHIR version validators
    # Sensitivity controlled by fhir4java.validation.health-check-mode

# Logging Configuration
logging:
  level:
    root: INFO
    org.fhirframework: DEBUG
    ca.uhn.fhir: INFO
    org.hibernate.SQL: DEBUG
    # For Hibernate 6.x (Spring Boot 3.x), use this instead of type.descriptor.sql
    org.hibernate.orm.jdbc.bind: TRACE
    org.springframework.web: DEBUG
    # Plugin loggers
    audit: INFO
    metrics: INFO
    org.fhirframework.plugin: DEBUG

---
# Development Profile
spring:
  config:
    activate:
      on-profile: dev

  jpa:
    show-sql: true

---
# Test Profile
spring:
  config:
    activate:
      on-profile: test

  datasource:
    url: jdbc:h2:mem:fhir4java_test;MODE=PostgreSQL;DB_CLOSE_DELAY=-1;INIT=CREATE SCHEMA IF NOT EXISTS FHIR\;CREATE SCHEMA IF NOT EXISTS CAREPLAN\;CREATE ALIAS IF NOT EXISTS jsonb_extract_path_text FOR "org.fhirframework.persistence.h2.H2JsonFunctions.jsonb_extract_path_text"\;CREATE ALIAS IF NOT EXISTS to_number FOR "org.fhirframework.persistence.h2.H2JsonFunctions.to_number"
    driver-class-name: org.h2.Driver
    username: fhir4java
    password: fhir4java

  jpa:
    hibernate:
      ddl-auto: create-drop
    properties:
      hibernate:
        dialect: org.hibernate.dialect.H2Dialect

  flyway:
    enabled: false

  data:
    redis:
      repositories:
        enabled: false

  cache:
    type: simple
